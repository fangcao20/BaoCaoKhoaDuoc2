{% extends "base.html" %}

{% block content %}
<div class="container">
    <h3>Phân quyền</h3>
    <input type="text" name="new_username" id="new_username" class="form-control" size=64 required placeholder="Tên đăng nhập">
    <span class="text-secondary" style="font-size: 12px"><i>***Mật khẩu mới được tự động đặt là '123123'.</i></span>
    <h6 class="mt-3">Chọn quyền:</h6>
    <div class="d-flex">
        {% for a in accesses %}
        <div class="form-check me-4">
          <input class="form-check-input" type="checkbox" value="" id="{{ a.id }}" />
          <label class="form-check-label" for="{{ a.id }}">{{ a.name }}</label>
        </div>
        {% endfor %}
        </div>
    <div class="mt-3">
        <button type="button" class="btn btn-sm btn-success" style="width: 100px" onclick="add_employee()">Thêm</button>
        <button type="button" class="btn btn-sm btn-danger" style="width: 100px" onclick="delete_employee()">Xoá</button>
    </div>
    <h6 class="mt-5">Danh sách nhân viên:</h6>
    <table class="table align-middle mb-0 bg-white table-sm table-hover  table-bordered">
        <thead class="bg-light">
            <tr>
                <th>STT</th>
                <th>Tên đăng nhập</th>
                <th>Quyền</th>
            </tr>
        </thead>
        <tbody id="table_employee">
            {% for e in employees %}
                <tr>
                    <th>{{ loop.index }}</th>
                    <td>{{ e.username }}</td>
                    <td>
                        {% set as = e.get_accesses().all() %}
                        {% for a in as %}
                        <li class="mb-0">{{ a.name }}</li>
                        {% endfor %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<script>
    function show_employees(employees) {
        var html = '';
        var i = 1;
        for (const r of employees) {
            html += `<tr>
                <th>${i}</th>
                <td>${r.username}</td>`;
            var accesses = '';
            for (const a of r.accesses) {
                accesses += `<li class="mb-0">${a}</li>`;
            }
            html += `<td>${accesses}</td></tr>`;
            i++;
        }
        document.getElementById('table_employee').innerHTML = html;
    }

    function show_flash(flashMessages) {
        $('#flash-messages').innerHTML = '<ul></ul>';
        flashMessages.forEach(function(flashMessage) {
            var category = flashMessage.category;
            var message = flashMessage.message;
            var flashMessageElement = `
                <li style="list-style-type: none">
                    <div class="alert alert-${category} alert-dismissible fade show" role="alert" data-mdb-color="${category}">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                </li>
            `;
            $('#flash-messages').append(flashMessageElement);
            $(".btn-close").on('click', function() {
              console.log('here');
              $(this).closest(".alert").fadeTo(500, 0).slideUp(500, function(){
                  $(this).remove();
              });
            });
        });
    }

    function add_employee() {
        var checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
        var access_ids = [];
        checkboxes.forEach(function(checkbox) {
            access_ids.push(checkbox.id);
        });
        $.post('/add-employee', {
            username: $('#new_username')[0].value,
            accesses: access_ids,
        }).done(function(response) {
            var flashMessages = response.flash_messages;
            if (flashMessages) {
               show_flash(flashMessages);
            }
            var employees = response.employees;
            if (employees) {
                show_employees(employees);
            }
        }).fail(function() {
            $('#table_employee').text('Lỗi: Không thể kết nối với máy chủ.');
        })
    }

    var rows = $('#table_employee')[0].rows;
    selectRowTable(rows, show_input);
    function show_input(row) {
        $('#new_username')[0].value = row.cells[1].textContent;
        var accesses = row.cells[2].querySelectorAll('li');
        var checkboxes = document.querySelectorAll('input[type="checkbox"]');
        for (c of checkboxes) {
            for (a of accesses) {
                if (c.nextElementSibling.textContent == a.textContent) {
                    c.checked = true;
                    break;
                } else {
                    c.checked = false;
                }
            }
        }
    }

    function delete_employee() {
        $.post('/delete-employee', {
            username: $('#new_username')[0].value,
        }).done(function(response) {
            var flashMessages = response.flash_messages;
            if (flashMessages) {
                show_flash(flashMessages);
            }
            var employees = response.employees;
            if (employees) {
                show_employees(employees);
            }
        }).fail(function() {
            $('#table_employee').text('Lỗi: Không thể kết nối với máy chủ.');
        })
    }
</script>
{% endblock %}